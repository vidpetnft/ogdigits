<!DOCTYPE html>
<html>
   <head>
        <link href='https://fonts.googleapis.com/css?family=Open Sans' rel='stylesheet'>
        <link rel="stylesheet" href="style.css">
        <link rel="icon" href="img/icon.png">

        <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha3/0.8.0/sha3.min.js" integrity="sha512-PmGDkK2UHGzTUfkFGcJ8YSrD/swUXekcca+1wWlrwALIZho9JX+3ddaaI9wmmf8PmgDIpMtx6TU8YBJAZS0mPQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        
        <title>OG Digits Club</title>
    </head>
    <body onload="fetchDigits();">
        <div class="container">
            <div class="topbar">
                 <div class="toptitle">
                    <p>ogdigits.club by</p>
                    <img src="img/twitter-logo.png" width="22px">
                    <a href="https://twitter.com/vidpetnft" target="_blank">vidpet</a>
                </div>
                <div class="topnav">
                    <a href="/context">Context</a>
                    <a class="active" href="/links">OG Digits</a>
                </div>
            </div>
            <h1>OG Digits Club</h1>
            <h2>All the digit ENS names registered in 2017</h2>
            <div class="digitlist">
            </div>
        </div>

        <script>
            function fetchDigitsLocal(){
                const json = {
                   jsonData:  [
                      {
                        "id": 1,
                        "name": 31415926535897932,
                        "regdate": "2017-05-10 7:21"
                      },
                      {
                        "id": 2,
                        "name": 6888888,
                        "regdate": "2017-05-11 20:12"
                      },
                      {
                        "id": 3,
                        "name": 6668888,
                        "regdate": "2017-05-14 14:09"
                      },
                      {
                        "id": 8,
                        "name": "0005555",
                        "regdate": "2017-05-16 0:08"
                      }
                    ]
                }; 

                render(json.jsonData);
            }

            function fetchDigits(){
                fetch("./2017digits.json")
                .then(response => response.json())
                .then(jsonData => render(jsonData));
            }

            function render(jsonData){
                for (var key in jsonData){
                    const digitPrice = "-";
                    const digitName = String(jsonData[key].name);
                    const digitHash = getDigitHash(digitName);
                    renderDigit(jsonData[key].id, digitName, digitPrice, jsonData[key].regdate, digitHash);
                }

                //fetchTokenPrices(jsonData);
            }

            function renderDigit(digitId, digitName, digitPrice, digitRegDate, digitHash){
                const digitOSLink = "https://opensea.io/assets/0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85/"+digitHash;
                const digitENSLink = "https://app.ens.domains/name/"+digitName+".eth/details";
                digitDiv = $("<div class=\"digit\">");
                digitIdDiv = $("<div class=\"digit-id\">#"+digitId+"</div>");
                digitNameDiv = $("<div class=\"digit-name\">"+digitName+".eth</div>");
                digitPriceDiv = $(" <div class=\"digit-price\" id=\""+digitHash+"\">"+digitPrice+"</div>");
                digitRegDateDiv = $("<div class=\"digit-regdate\">"+digitRegDate+"</div>");
                digitOSLinkDiv = $("<div class=\"digit-oslink\"><a href=\""+digitOSLink+"\" target=\"_blank\"><img src=\"img/os-logo.png\" height=\"22px\"></a></div>");
                digitENSLinkDiv = $("<div class=\"digit-enslink\"><a href=\""+digitENSLink+"\" target=\"_blank\"><img src=\"img/ens-logo.png\" height=\"22px\"></a></div> ");
                digitDiv.append(digitIdDiv, digitNameDiv, digitPriceDiv, digitRegDateDiv, digitOSLinkDiv, digitENSLinkDiv);
                $(".digitlist").append(digitDiv);
            }

            function fetchTokenPrices(jsonData){
                const tokensAPI = "https://api.reservoir.tools/tokens/v4";

                var parameters = "";
                var count = 0;
                for (var key in jsonData){
                    parameters+=(parameters.length>0 ? "&" : "?");
                    parameters+="tokens=0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85:"+getDigitHash(String(jsonData[key].name));
                    count++;
                    if (count > 48){
                        fetch(tokensAPI+parameters)
                            .then(response => response.json())
                            .then(data => updateDigitPrices(data));
                        count = 0;
                        parameters = "";
                    }
                }
            }

            function updateDigitPrices(data)
            {
                for (var key in data.tokens)
                {
                    if (data.tokens[key].floorAskPrice != null){
                        $("#"+data.tokens[key].tokenId).text(data.tokens[key].floorAskPrice+"Îž");
                    }
                }

            }

            function getDigitHash(digitName){
                const labelHash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(digitName));
                const tokenId = ethers.BigNumber.from(labelHash).toString();
                return tokenId;
            }

        </script>


    </body>
</html>
