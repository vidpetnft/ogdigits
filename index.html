<!DOCTYPE html>
<html>
   <head>
        <link href='https://fonts.googleapis.com/css?family=Open Sans' rel='stylesheet'>
        <link rel="stylesheet" href="style.css">
        <link rel="icon" href="img/icon.png">

        <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha3/0.8.0/sha3.min.js" integrity="sha512-PmGDkK2UHGzTUfkFGcJ8YSrD/swUXekcca+1wWlrwALIZho9JX+3ddaaI9wmmf8PmgDIpMtx6TU8YBJAZS0mPQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        
        <title>OG Digits Club</title>
    </head>
    <body onload="loadDigits();">
        <div class="container">
            <div class="toptitle">
                <h1>OG Digits Club</h1>
                <a href="https://twitter.com/vidpetnft" target="_blank">vidpet</a>
                <img src="img/twitter-logo.png" width="22px">
                <p>by</p>
            </div>
            <h2>All the digit ENS names registered in 2017</h2>
            <div class="filterContainer">
                <label class="filterLabel">Pre Punk:</label>
                <label class="switch">
                    <input type="checkbox" id="pre-punk-filter" onclick="filterList()">
                    <span class="slider round"></span>
                </label>
                <label class="filterLabel">Buy Now:</label>
                <label class="switch">
                    <input type="checkbox" id="buy-now-filter" onclick="filterList()">
                    <span class="slider round"></span>
                </label>
                <label class="filterLabel">Available:</label>
                <label class="switch">
                    <input type="checkbox" id="available-filter" onclick="filterList()">
                    <span class="slider round"></span>
                </label>
                <div class="listLengthInfo">0 Item</div>
            </div>
            <div class="digitlist">
            </div>
        </div>

        <script>
            localStorage.clear();
            var localTest = false;

            const CACHE_INVALIDATION_TIME = 300*1000;
            const PRE_PUNK_CUT_OFF = 424;
            var digits;

            function loadDigits(){
                if (localStorage.digits == null){
                    fetchDigits();
                }
                else{
                    digits = JSON.parse(localStorage.digits);
                    render();
                }
            }

            function fetchDigits(){
                if (localTest){
                    storeDigits(testJson.jsonData);
                }
                else{
                    fetch("./2017digits.json")
                    .then(response => response.json())
                    .then(jsonData => storeDigits(jsonData));
                }
            }

            function storeDigits(jsonData){
                digits = new Object();

                for (var key in jsonData){
                    var digitNameHash = getDigitHash(String(jsonData[key].name));
                    digits[digitNameHash] = jsonData[key];
                    digits[digitNameHash].price = 0;
                }

                localStorage.pricesUpdatedAt = -1;
                localStorage.digits = JSON.stringify(digits);

                render();
            }

            function render(){
                for (var nameHash in digits){
                    renderDigit(digits[nameHash].id, String(digits[nameHash].name), digits[nameHash].price, digits[nameHash].regdate, nameHash);
                }

                updateListLengthInfo(Object.keys(digits).length);

                fetchTokenPrices();
            }

            function renderDigit(digitId, digitName, digitPrice, digitRegDate, digitHash){
                const digitOSLink = "https://opensea.io/assets/0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85/"+digitHash;
                const digitENSLink = "https://app.ens.domains/name/"+digitName+".eth/details";

                digitDiv = $("<div class=\"digit\" id=\""+digitHash+"\">");
                digitIdDiv = $("<div class=\"digit-id\">#"+digitId+"</div>");
                digitNameDiv = $("<div class=\"digit-name\" style=\"background-color:"+getCellColor(digitPrice)+"\">"+digitName+".eth</div>");
                digitPriceDiv = $(" <div class=\"digit-price\">"+getPriceLabel(digitPrice)+"</div>");
                digitRegDateDiv = $("<div class=\"digit-regdate\">"+digitRegDate+"</div>");
                digitOSLinkDiv = $("<div class=\"digit-oslink\"><a href=\""+digitOSLink+"\" target=\"_blank\"><img src=\"img/os-logo.png\" height=\"22px\"></a></div>");
                digitENSLinkDiv = $("<div class=\"digit-enslink\"><a href=\""+digitENSLink+"\" target=\"_blank\"><img src=\"img/ens-logo.png\" height=\"22px\"></a></div> ");

                digitDiv.append(digitIdDiv, digitNameDiv, digitPriceDiv, digitRegDateDiv, digitOSLinkDiv, digitENSLinkDiv);
                $(".digitlist").append(digitDiv);
            }

            function fetchTokenPrices(){
                if (Date.now() - localStorage.pricesUpdatedAt > CACHE_INVALIDATION_TIME){
                    const tokensAPI = "https://api.reservoir.tools/tokens/v4";

                    var parameters = "";
                    var count = 0;
                    for (var nameHash in digits){
                        parameters+=(parameters.length>0 ? "&" : "?");
                        parameters+="tokens=0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85:"+(nameHash);
                        count++;
                        if (count > 48){
                            fetch(tokensAPI+parameters)
                                .then(response => response.json())
                                .then(data => updateDigits(data));
                            count = 0;
                            parameters = "";
                        }
                    }
                    if (count > 0){
                        console.log("fetching tokens: "+tokensAPI+parameters);
                        fetch(tokensAPI+parameters)
                            .then(response => response.json())
                            .then(data => updateDigits(data));
                    }
                }
            }

            function updateDigits(data)
            {
                for (var key in data.tokens)
                {
                    const nameHash = data.tokens[key].tokenId;

                    if (data.tokens[key].floorAskPrice != null){
                        digits[nameHash].price = data.tokens[key].floorAskPrice;
                    }
                    else if (data.tokens[key].name == null){
                        digits[nameHash].price = -1;
                    }
                    else{
                        digits[nameHash].price = 0;
                    }

                    $("#"+nameHash+" > .digit-name").css("background-color", getCellColor(digits[nameHash].price));
                    $("#"+nameHash+" > .digit-price").text(getPriceLabel(digits[nameHash].price));
                }

                localStorage.pricesUpdatedAt = Date.now();
                localStorage.digits = JSON.stringify(digits);
            }

            function filterList(){
                var count = 0;
                for (var nameHash in digits){
                    var digitVisible = true;
                    if ($("#pre-punk-filter").is(":checked") && digits[nameHash].id>PRE_PUNK_CUT_OFF){
                        digitVisible = false;
                    }
                    if ($("#buy-now-filter").is(":checked") && digits[nameHash].price<=0){
                        digitVisible = false;
                    }
                    if ($("#available-filter").is(":checked") && digits[nameHash].price>=0){
                        digitVisible = false;
                    }

                    console.log("id:"+digits[nameHash].id+",price:"+digits[nameHash].price+",visible:"+digitVisible);

                    if (digitVisible){
                        $("#"+nameHash).show();
                        count++;
                    }
                    else{
                        $("#"+nameHash).hide();
                    }
                }

                updateListLengthInfo(count);
            }

            function getDigitHash(digitName){
                const labelHash = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(digitName));
                const tokenId = ethers.BigNumber.from(labelHash).toString();
                return tokenId;
            }

            function updateListLengthInfo(length){
                $(".listLengthInfo").text(length+" Items");
            }

            function getCellColor(digitPrice){
                var cellColor = "#ffffff";
                if (digitPrice < 0){
                    cellColor = "#b8e6c2";
                }
                else if (digitPrice > 0){
                    cellColor = "#a5c8ec";
                }
                return cellColor;
            }

            function getPriceLabel(digitPrice){
                return (digitPrice>0) ? digitPrice+"Îž" : "-";
            }

            const testJson = {
                       jsonData:  [
                          {
                            "id": 1,
                            "name": 31415926535897932,
                            "regdate": "2017-05-10 7:21"
                          },
                          {
                            "id": 2,
                            "name": 6888888,
                            "regdate": "2017-05-11 20:12"
                          },
                          {
                            "id": 3,
                            "name": 6668888,
                            "regdate": "2017-05-14 14:09"
                          },
                          {
                            "id": 8,
                            "name": "0005555",
                            "regdate": "2017-05-16 0:08"
                          },
                            {
                            "id": 431,
                            "name": 5555558,
                            "regdate": "2017-06-24 3:13"
                          }
                        ]
                    };  

        </script>


    </body>
</html>
